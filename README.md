# tree2secondaries

**[ROOT](https://root.cern.ch)**-based standalone application that serves as:
- Second step: analyzes **[ROOT](https://root.cern.ch)** TTrees generated by **[esd2vector](https://github.com/hd-alice-sexaquark/esd2vector)** into event-vector format where V0s are packed.
- Third step: analyzes packed event-vector-based packed V0s into flat-format found anti-sexaquarks.

## Requirements

- CMake (v3.25 or higher)
- C++ compiler compatible with C++23
- Internet connection to fetch **[CLIUtils/CLI11](https://github.com/CLIUtils/CLI11)**
- **[ROOT](https://root.cern.ch)**
- **[KFParticle](https://github.com/HD-ALICE-Sexaquark/KFParticle)**

## Building

```bash
mkdir -p build && cd build
cmake ../ -DKFParticle_DIR=<kfparticle-location> <options>
cmake --build .
```

Additional `<options>`:

* `-DT2S_DEBUG=ON` -- (default: OFF) enable debug messages
* `-DENABLE_PROFILING=ON` -- (default: OFF) enable profiling (see below)

## Usage

```
./src/App -i [-o,-n] pack mc [-s] [-c,-a]
./src/App -i [-o,-n] pack data
./src/App -i [-o,-n] search mc [-m] [-c,-a]
./src/App -i [-o,-n] search data [-c,-a]

SUBCOMMANDS:
  pack    Package V0s and necessary tracks
  search  Search for anti-sexaquark reactions
  data    Process data
  mc      Process MC (requires -m)
OPTIONS:
  -h,--help                     Print help message and exit
  -i,--input {PATH}             [REQUIRED] Path(s) of input file(s)
  -o,--output {PATH}            Path of output file
  -n,--nevents {N}              Limit to N events
  -m,--mass {MASS}              Injected anti-sexaquark Mass
  -c,--channel {A,D,E,H}        Process a standard reaction channel
  -a,--anti    {A,D,E,H}        Process an anti-reaction channel
```

## Quick Reference

```bash
./src/App -i ../files/data_15o/AnalysisResults_data_15o_245554_001.root -n 100 pack data
root -l -b -q Packed_AllChannels_Data.root -e 'PackedEvents->GetListOfLeaves()->Print()'
./src/App -i Packed_AllChannels_Data.root -n 100 search -c A data
root Packed_SignalMC_ChannelA_1.80.root -e 'PackedEvents->SetAlias("AL_M", "TMath::Sqrt(AL_E*AL_E-AL_Px*AL_Px-AL_Py*AL_Py-AL_Pz*AL_Pz)") ; PackedEvents->Draw("AL_M")'
root Packed_SignalMC_ChannelA_1.80.root -e 'PackedEvents->SetAlias("AL_M", "TMath::Sqrt(AL_E*AL_E-AL_Px*AL_Px-AL_Py*AL_Py-AL_Pz*AL_Pz)") ; PackedEvents->Draw("AL_M", "AL_MC_IsSignal")'

root -l -b -q Searched_SignalMC_ChannelA_1.80.root -e 'CandidatesChannelA->Scan("Entry:V0A_Entry:V0A_Neg_Entry:V0A_Pos_Entry:V0B_Entry:V0B_Neg_Entry:V0B_Pos_Entry:MC_V0A_Entry:MC_V0A_Mother_Entry:MC_V0A_Neg_Entry:MC_V0A_Pos_Entry:MC_V0B_Entry:MC_V0B_Mother_Entry:MC_V0B_Neg_Entry:MC_V0B_Pos_Entry")'

# verify resolution of V0s position
root -l -b -q Packed_SignalMC_ChannelA_1.80.root -e 'PackedEvents->Scan("AL_X:AL_Y:AL_Z:AL_MC_DecayX:AL_MC_DecayY:AL_MC_DecayZ:AL_Neg_X_AtPCA:AL_Neg_Y_AtPCA:AL_Neg_Z_AtPCA:AL_MC_Neg_X:AL_MC_Neg_Y:AL_MC_Neg_Z:AL_Pos_X_AtPCA:AL_Pos_Y_AtPCA:AL_Pos_Z_AtPCA:AL_MC_Pos_X:AL_MC_Pos_Y:AL_MC_Pos_Z", "AL_MC_IsTrue")'
root -l -b -q Packed_SignalMC_ChannelA_1.80.root -e 'PackedEvents->Scan("K0S_X:K0S_Y:K0S_Z:K0S_MC_DecayX:K0S_MC_DecayY:K0S_MC_DecayZ", "K0S_MC_IsTrue")'

# verify resolution of V0s kinematics
root -l -b -q Packed_SignalMC_ChannelA_1.80.root -e 'PackedEvents->Scan("AL_Px:AL_Py:AL_Pz:AL_MC_DecayX:AL_MC_DecayY:AL_MC_DecayZ:AL_Neg_Px_AtPCA:AL_Neg_Py_AtPCA:AL_Neg_Pz_AtPCA:AL_MC_Neg_Px:AL_MC_Neg_Py:AL_MC_Neg_Pz:AL_Pos_Px_AtPCA:AL_Pos_Py_AtPCA:AL_Pos_Pz_AtPCA:AL_MC_Pos_Px:AL_MC_Pos_Py:AL_MC_Pos_Pz", "AL_MC_IsTrue")'

# verify resolution of SV coordinates
root -l -b -q Searched_SignalMC_ChannelA_1.80.root -e 'CandidatesChannelA->Scan("X:Y:Z:MC_X:MC_Y:MC_Z")'
# verify resolution of sexaquark's momentum after interaction
root -l -b -q Searched_SignalMC_ChannelA_1.80.root -e 'CandidatesChannelA->Scan("Px:Py:Pz:MC_Px_After:MC_Py_After:MC_Pz_After")'

# check signal mc V0s invariant mass
root Packed_Data_AllChannels.root -e 'PackedEvents->SetAlias("K0S_M", "TMath::Sqrt(K0S_E*K0S_E-K0S_Px*K0S_Px-K0S_Py*K0S_Py-K0S_Pz*K0S_Pz)") ; PackedEvents->Draw("K0S_M")'

# check data V0s invariant mass
root Packed_Data_AllChannels.root -e 'PackedEvents->SetAlias("AL_M", "TMath::Sqrt(AL_E*AL_E-AL_Px*AL_Px-AL_Py*AL_Py-AL_Pz*AL_Pz)") ; PackedEvents->Draw("AL_M")'
root Packed_Data_AllChannels.root -e 'PackedEvents->SetAlias("K0S_M", "TMath::Sqrt(K0S_E*K0S_E-K0S_Px*K0S_Px-K0S_Py*K0S_Py-K0S_Pz*K0S_Pz)") ; PackedEvents->Draw("K0S_M")'

# check data V0s decay radius
root -l -b -q Packed_Data_AllChannels.root -e 'PackedEvents->SetAlias("AL_Radius", "TMath::Sqrt(AL_X*AL_X + AL_Y*AL_Y)") ; PackedEvents->Scan("AL_X:AL_Y:AL_Z:AL_Radius")'
root Packed_Data_AllChannels.root -e 'PackedEvents->SetAlias("AL_Radius", "TMath::Sqrt(AL_X*AL_X + AL_Y*AL_Y)") ; PackedEvents->Draw("AL_Radius")'
root Packed_Data_AllChannels.root -e 'PackedEvents->SetAlias("K0S_Radius", "TMath::Sqrt(K0S_X*K0S_X + K0S_Y*K0S_Y)") ; PackedEvents->Draw("K0S_Radius")'
```

## Debugging

```bash
root -l -b -q Packed_ChannelA_SignalMC_1.80.root -e 'PackedEvents->Scan("TMath::Sqrt(K0S_E*K0S_E-K0S_Px*K0S_Px-K0S_Py*K0S_Py-K0S_Pz*K0S_Pz):TMath::Sqrt(K0S_X*K0S_X+K0S_Y*K0S_Y):K0S_MC_IsSignal:K0S_MC_ReactionID:EventNumber")'
root -l -b -q Packed_ChannelA_SignalMC_1.80.root -e 'PackedEvents->Scan("TMath::Sqrt(AL_E*AL_E-AL_Px*AL_Px-AL_Py*AL_Py-AL_Pz*AL_Pz):TMath::Sqrt(AL_X*AL_X+AL_Y*AL_Y):AL_MC_IsSignal:AL_MC_ReactionID:EventNumber")'
```

## Memory Leaks

```bash
valgrind --leak-check=full --suppressions=$(root-config --etcdir)/valgrind-root.supp APP &> LOG
```

## Profiling

```bash
mkdir profile && cd build
cmake ../ -DCMAKE_EXPORT_COMPILE_COMMANDS=1 -DENABLE_PROFILING=ON
cmake --build .
cd apps/
./App [options] # will generate gmon.out
gprof App > gprof.log
```
